import { __decorate } from "tslib";
import { ChangeDetectorRef, Component, ElementRef, OnInit, ViewChild } from '@angular/core';
import { IconPickerService } from './icon-picker.service';
import { IconType } from './icon';
let IconPickerComponent = class IconPickerComponent {
    constructor(el, cdr, service) {
        this.el = el;
        this.cdr = cdr;
        this.service = service;
        this.iconType = IconType;
        this.dialogArrowSize = 10;
        this.icons = [];
        this.search = '';
    }
    setDialog(instance, elementRef, icon, ipPosition, ipHeight, ipMaxHeight, ipWidth, ipPlaceHolder, ipFallbackIcon, ipIconPack, ipIconSize, ipIconVerticalPadding, ipIconHorizontalPadding, ipButtonStyleClass, ipDivSearchStyleClass, ipInputSearchStyleClass, ipKeepSearchFilter) {
        this.directiveInstance = instance;
        this.setInitialIcon(icon);
        this.directiveElementRef = elementRef;
        this.ipPosition = ipPosition;
        this.ipHeight = parseInt(ipHeight, 10);
        this.ipMaxHeight = parseInt(ipMaxHeight, 10);
        this.ipWidth = parseInt(ipWidth, 10);
        if (!this.ipWidth) {
            this.ipWidth = elementRef.nativeElement.offsetWidth;
        }
        this.ipIconSize = parseInt(ipIconSize, 10);
        this.ipIconVerticalPadding = parseInt(ipIconVerticalPadding, 10);
        this.ipIconHorizontalPadding = parseInt(ipIconHorizontalPadding, 10);
        this.ipKeepSearchFilter = JSON.parse(ipKeepSearchFilter);
        this.ipPlaceHolder = ipPlaceHolder;
        this.ipFallbackIcon = ipFallbackIcon;
        this.ipIconPack = ipIconPack;
        this.ipButtonStyleClass = ipButtonStyleClass;
        this.ipInputSearchStyleClass = ipInputSearchStyleClass;
        this.ipDivSearchStyleClass = ipDivSearchStyleClass;
        this.buttonHeight = this.ipIconSize + 2 * this.ipIconVerticalPadding;
        this.buttonWidth = this.ipIconSize + 2 * this.ipIconHorizontalPadding;
    }
    ngOnInit() {
        this.icons = this.service.getIcons(this.ipIconPack);
        this.listenerMouseDown = (event) => this.onMouseDown(event);
        this.listenerResize = () => this.onResize();
        this.openDialog(this.initialIcon);
    }
    setInitialIcon(icon) {
        this.initialIcon = icon;
        this.selectedIcon = this.icons.find(el => el ?
            `fa fa-${el.id}` === icon || `glyphicon glyphicon-${el.id}` === icon || `${el.id}` === icon :
            false);
        if (this.ipKeepSearchFilter && this.selectedIcon && icon !== this.ipFallbackIcon) {
            this.search = this.selectedIcon.id;
        }
        else {
            this.search = '';
        }
    }
    openDialog(icon) {
        this.setInitialIcon(icon);
        this.openIconPicker();
    }
    setSearch(val) {
        this.search = val;
    }
    selectIcon(icon) {
        if (icon.type === IconType.FONT_AWESEOME) {
            this.directiveInstance.iconSelected(`fa fa-${icon.id}`);
        }
        else if (icon.type === IconType.BOOTSTRAP) {
            this.directiveInstance.iconSelected(`glyphicon glyphicon-${icon.id}`);
        }
        else if (icon.type === IconType.FONT_AWESEOME5) {
            this.directiveInstance.iconSelected(`${icon.id}`);
        }
        else if (icon.type === IconType.MATERIAL) {
            this.directiveInstance.iconSelected(`${icon.id}`);
        }
        this.closeIconPicker();
    }
    onMouseDown(event) {
        if (!this.isDescendant(this.el.nativeElement, event.target) && event.target !== this.directiveElementRef.nativeElement) {
            this.closeIconPicker();
        }
    }
    openIconPicker() {
        if (!this.show) {
            this.show = true;
            this.hidden = true;
            setTimeout(() => {
                this.setDialogPosition();
                this.hidden = false;
                this.cdr.detectChanges();
            }, 0);
            document.addEventListener('mousedown', this.listenerMouseDown);
            window.addEventListener('resize', this.listenerResize);
        }
    }
    closeIconPicker() {
        if (this.show) {
            this.show = false;
            document.removeEventListener('mousedown', this.listenerMouseDown);
            window.removeEventListener('resize', this.listenerResize);
            this.cdr.detectChanges();
        }
    }
    onResize() {
        if (this.position === 'fixed') {
            this.setDialogPosition();
        }
    }
    setDialogPosition() {
        const dialogHeight = this.dialogElement.nativeElement.offsetHeight;
        let node = this.directiveElementRef.nativeElement;
        let position = 'static';
        let transform = '';
        let parentNode = null;
        let transformNode = null;
        let style = null;
        while (node !== null && node.tagName !== 'HTML') {
            style = window.getComputedStyle(node);
            position = style.getPropertyValue('position');
            transform = style.getPropertyValue('transform');
            if (position !== 'static' && parentNode === null) {
                parentNode = node;
            }
            if (transform && transform !== 'none' && transformNode === null) {
                transformNode = node;
            }
            if (position === 'fixed') {
                parentNode = transformNode;
                break;
            }
            node = node.parentNode;
        }
        const boxDirective = this.createBox(this.directiveElementRef.nativeElement, (position !== 'fixed'));
        if (position !== 'fixed' || parentNode) {
            if (parentNode === null) {
                parentNode = node;
            }
            const boxParent = this.createBox(parentNode, true);
            this.top = boxDirective.top - boxParent.top;
            this.left = boxDirective.left - boxParent.left;
        }
        else {
            this.top = boxDirective.top;
            this.left = boxDirective.left;
        }
        if (position === 'fixed') {
            this.position = 'fixed';
        }
        if (this.ipPosition === 'left') {
            this.left -= this.ipWidth + this.dialogArrowSize - 2;
        }
        else if (this.ipPosition === 'top') {
            this.top -= dialogHeight + this.dialogArrowSize;
            this.arrowTop = dialogHeight - 1;
        }
        else if (this.ipPosition === 'bottom') {
            this.top += boxDirective.height + this.dialogArrowSize;
        }
        else {
            this.left += boxDirective.width + this.dialogArrowSize - 2;
        }
    }
    isDescendant(parent, child) {
        let node = child.parentNode;
        while (node !== null) {
            if (node === parent) {
                return true;
            }
            node = node.parentNode;
        }
        return false;
    }
    createBox(element, offset) {
        return {
            top: element.getBoundingClientRect().top + (offset ? window.pageYOffset : 0),
            left: element.getBoundingClientRect().left + (offset ? window.pageXOffset : 0),
            width: element.offsetWidth,
            height: element.offsetHeight
        };
    }
};
IconPickerComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: ChangeDetectorRef },
    { type: IconPickerService }
];
__decorate([
    ViewChild('dialogPopup')
], IconPickerComponent.prototype, "dialogElement", void 0);
IconPickerComponent = __decorate([
    Component({
        // tslint:disable-next-line: component-selector
        selector: 'icon-picker',
        template: "<div class=\"icon-picker\" #dialogPopup\r\n     [hidden]=\"!show\"\r\n     [style.visibility]=\"this.hidden ? 'hidden' : 'visible'\"\r\n     [style.height.px]=\"ipHeight\"\r\n     [style.width.px]=\"ipWidth\"\r\n     [style.top.px]=\"top\"\r\n     [style.left.px]=\"left\"\r\n     [style.position]=\"position\">\r\n\r\n  <div class=\"arrow arrow-{{ipPosition}}\" [style.top.px]=\"arrowTop\"></div>\r\n\r\n  <div class=\"icon-search {{ipDivSearchStyleClass}}\">\r\n    <input type=\"text\" class=\"{{ipInputSearchStyleClass}}\" [text] [value]=\"search\" (newValue)=\"setSearch($event)\"\r\n           [placeholder]=\"ipPlaceHolder\">\r\n  </div>\r\n  <div class=\"icon-grid\" [ngStyle]=\"{'max-height.px': ipMaxHeight}\">\r\n    <div *ngFor=\"let icon of icons | searchIcon:search\">\r\n      <button *ngIf=\"icon\" class=\"ip-button-icon {{ipButtonStyleClass}}\" type=\"button\" title=\"{{ icon.name }}\"\r\n              [ngClass]=\"{active : icon === selectedIcon}\"\r\n              [style.width.px]=\"buttonWidth\"\r\n              [style.height.px]=\"buttonHeight\"\r\n              [style.padding-top.px]=\"ipIconVerticalPadding\"\r\n              [style.padding-bottom.px]=\"ipIconVerticalPadding\"\r\n              [style.padding-left.px]=\"ipIconHorizontalPadding\"\r\n              [style.padding-right.px]=\"ipIconHorizontalPadding\"\r\n              (click)=\"selectIcon(icon)\">\r\n        <span *ngIf=\"icon.type === iconType.FONT_AWESEOME\" class=\"fa fa-{{icon.id}}\"\r\n              [style.font-size.px]=\"ipIconSize\"></span>\r\n        <span *ngIf=\"icon.type === iconType.BOOTSTRAP\" class=\"glyphicon glyphicon-{{icon.id}}\"\r\n              [style.font-size.px]=\"ipIconSize\"></span>\r\n        <span *ngIf=\"icon.type === iconType.FONT_AWESEOME5\" class=\"{{icon.id}}\"\r\n              [style.font-size.px]=\"ipIconSize\"></span>\r\n        <span *ngIf=\"icon.type === iconType.MATERIAL\" class=\"material-icons\"\r\n              [style.font-size.px]=\"ipIconSize\">{{icon.id}}</span>\r\n      </button>\r\n    </div>\r\n  </div>\r\n\r\n</div>\r\n",
        styles: [".icon-picker{box-sizing:border-box;margin:0;position:absolute;z-index:100000;top:250px;left:30px;width:230px;height:auto;border:1px solid #777;cursor:default;background-color:#fff;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.icon-picker i{position:relative;cursor:default}.icon-picker .arrow{position:absolute;z-index:999999;width:0;height:0;border-style:solid}.icon-picker .arrow-right{top:10px;left:-20px;border-width:5px 10px;border-color:transparent #777 transparent transparent}.icon-picker .arrow-left{top:10px;left:100%;border-width:5px 10px;border-color:transparent transparent transparent #777}.icon-picker .arrow-bottom{top:-20px;left:10px;border-width:10px 5px;border-color:transparent transparent #777}.icon-picker .arrow-top{left:10px;border-width:10px 5px;border-color:#777 transparent transparent}.icon-picker div.icon-search{padding:5px}.icon-picker div.icon-grid{display:-webkit-box;display:flex;overflow-y:auto;-webkit-box-orient:horizontal;-webkit-box-direction:normal;flex-direction:row;flex-wrap:wrap;padding:5px}.icon-picker div.icon-grid div{margin:2px}.icon-picker div.cursor-sv{position:relative;width:15px;height:15px;border-radius:50%;border:1px solid #ddd;cursor:default}.icon-picker div.cursor{position:relative;width:16px;height:16px;border-radius:50%;border:2px solid #222;cursor:default}"]
    })
], IconPickerComponent);
export { IconPickerComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWNvbi1waWNrZXIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LWljb24tcGlja2VyLyIsInNvdXJjZXMiOlsibGliL2ljb24tcGlja2VyLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFDLGlCQUFpQixFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUUxRixPQUFPLEVBQUMsaUJBQWlCLEVBQUMsTUFBTSx1QkFBdUIsQ0FBQztBQUN4RCxPQUFPLEVBQU8sUUFBUSxFQUFDLE1BQU0sUUFBUSxDQUFDO0FBU3RDLElBQWEsbUJBQW1CLEdBQWhDLE1BQWEsbUJBQW1CO0lBNkM5QixZQUNVLEVBQWMsRUFDZCxHQUFzQixFQUN0QixPQUEwQjtRQUYxQixPQUFFLEdBQUYsRUFBRSxDQUFZO1FBQ2QsUUFBRyxHQUFILEdBQUcsQ0FBbUI7UUFDdEIsWUFBTyxHQUFQLE9BQU8sQ0FBbUI7UUFyQjdCLGFBQVEsR0FBRyxRQUFRLENBQUM7UUFXbkIsb0JBQWUsR0FBRyxFQUFFLENBQUM7UUFJN0IsVUFBSyxHQUFXLEVBQUUsQ0FBQztRQUNuQixXQUFNLEdBQUcsRUFBRSxDQUFDO0lBTVosQ0FBQztJQUVELFNBQVMsQ0FBQyxRQUFhLEVBQUUsVUFBc0IsRUFBRSxJQUFZLEVBQUUsVUFBa0IsRUFBRSxRQUFnQixFQUFFLFdBQW1CLEVBQzlHLE9BQWUsRUFBRSxhQUFxQixFQUFFLGNBQXNCLEVBQUUsVUFBb0IsRUFBRSxVQUFrQixFQUN4RyxxQkFBNkIsRUFBRSx1QkFBK0IsRUFBRSxrQkFBMEIsRUFBRSxxQkFBNkIsRUFDekgsdUJBQStCLEVBQUUsa0JBQTBCO1FBQ25FLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxRQUFRLENBQUM7UUFDbEMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMxQixJQUFJLENBQUMsbUJBQW1CLEdBQUcs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Q0FBQyxNQUFXLEVBQUUsS0FBVTtRQUNsQyxJQUFJLElBQUksR0FBUSxLQUFLLENBQUMsVUFBVSxDQUFDO1FBQ2pDLE9BQU8sSUFBSSxLQUFLLElBQUksRUFBRTtZQUNwQixJQUFJLElBQUksS0FBSyxNQUFNLEVBQUU7Z0JBQ25CLE9BQU8sSUFBSSxDQUFDO2FBQ2I7WUFDRCxJQUFJLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQztTQUN4QjtRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUVELFNBQVMsQ0FBQyxPQUFZLEVBQUUsTUFBZTtRQUNyQyxPQUFPO1lBQ0wsR0FBRyxFQUFFLE9BQU8sQ0FBQyxxQkFBcUIsRUFBRSxDQUFDLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzVFLElBQUksRUFBRSxPQUFPLENBQUMscUJBQXFCLEVBQUUsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUM5RSxLQUFLLEVBQUUsT0FBTyxDQUFDLFdBQVc7WUFDMUIsTUFBTSxFQUFFLE9BQU8sQ0FBQyxZQUFZO1NBQzdCLENBQUM7SUFDSixDQUFDO0NBQ0YsQ0FBQTs7WUFyTGUsVUFBVTtZQUNULGlCQUFpQjtZQUNiLGlCQUFpQjs7QUFSVjtJQUF6QixTQUFTLENBQUMsYUFBYSxDQUFDOzBEQUFvQjtBQXhDbEMsbUJBQW1CO0lBUC9CLFNBQVMsQ0FBQztRQUNULCtDQUErQztRQUMvQyxRQUFRLEVBQUUsYUFBYTtRQUN2QixzaUVBQTJDOztLQUU1QyxDQUFDO0dBRVcsbUJBQW1CLENBbU8vQjtTQW5PWSxtQkFBbUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NoYW5nZURldGVjdG9yUmVmLCBDb21wb25lbnQsIEVsZW1lbnRSZWYsIE9uSW5pdCwgVmlld0NoaWxkfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuXHJcbmltcG9ydCB7SWNvblBpY2tlclNlcnZpY2V9IGZyb20gJy4vaWNvbi1waWNrZXIuc2VydmljZSc7XHJcbmltcG9ydCB7SWNvbiwgSWNvblR5cGV9IGZyb20gJy4vaWNvbic7XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IGNvbXBvbmVudC1zZWxlY3RvclxyXG4gIHNlbGVjdG9yOiAnaWNvbi1waWNrZXInLFxyXG4gIHRlbXBsYXRlVXJsOiAnLi9pY29uLXBpY2tlci5jb21wb25lbnQuaHRtbCcsXHJcbiAgc3R5bGVVcmxzOiBbJy4vaWNvbi1waWNrZXIuY29tcG9uZW50LnNjc3MnXVxyXG59KVxyXG5cclxuZXhwb3J0IGNsYXNzIEljb25QaWNrZXJDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xyXG4gIC8vIFBvcG92ZXJcclxuICBwdWJsaWMgaXBQb3NpdGlvbjogc3RyaW5nO1xyXG4gIHB1YmxpYyBpcEhlaWdodDogbnVtYmVyO1xyXG4gIHB1YmxpYyBpcE1heEhlaWdodDogbnVtYmVyO1xyXG4gIHB1YmxpYyBpcFdpZHRoOiBudW1iZXI7XHJcbiAgLy8gSWNvbiBjc3NcclxuICBwdWJsaWMgaXBJY29uU2l6ZTogbnVtYmVyO1xyXG4gIHB1YmxpYyBpcEljb25WZXJ0aWNhbFBhZGRpbmc6IG51bWJlcjtcclxuICBwdWJsaWMgaXBJY29uSG9yaXpvbnRhbFBhZGRpbmc6IG51bWJlcjtcclxuICAvLyBJdGVtIFN0eWxlIGllIGlucHV0IGFuZCBidXR0b25cclxuICBwdWJsaWMgaXBCdXR0b25TdHlsZUNsYXNzOiBzdHJpbmc7XHJcbiAgcHVibGljIGlwSW5wdXRTZWFyY2hTdHlsZUNsYXNzOiBzdHJpbmc7XHJcbiAgcHVibGljIGlwRGl2U2VhcmNoU3R5bGVDbGFzczogc3RyaW5nO1xyXG4gIC8vIEljb24gYW5kIGJlaGF2aW9yc1xyXG4gIHB1YmxpYyBpcEtlZXBTZWFyY2hGaWx0ZXI6IGJvb2xlYW47XHJcbiAgcHVibGljIGlwUGxhY2VIb2xkZXI6IHN0cmluZztcclxuICBwdWJsaWMgaXBGYWxsYmFja0ljb246IHN0cmluZztcclxuICBwdWJsaWMgaXBJY29uUGFjazogc3RyaW5nW107XHJcblxyXG4gIHB1YmxpYyBzaG93OiBib29sZWFuO1xyXG4gIHB1YmxpYyBoaWRkZW46IGJvb2xlYW47XHJcbiAgcHVibGljIHRvcDogbnVtYmVyO1xyXG4gIHB1YmxpYyBsZWZ0OiBudW1iZXI7XHJcbiAgcHVibGljIHBvc2l0aW9uOiBzdHJpbmc7XHJcbiAgcHVibGljIGFycm93VG9wOiBudW1iZXI7XHJcbiAgcHVibGljIHNlbGVjdGVkSWNvbjogSWNvbjtcclxuICBwdWJsaWMgaWNvblR5cGUgPSBJY29uVHlwZTtcclxuICBwdWJsaWMgYnV0dG9uV2lkdGg6IG51bWJlcjtcclxuICBwdWJsaWMgYnV0dG9uSGVpZ2h0OiBudW1iZXI7XHJcblxyXG4gIHByaXZhdGUgZGlyZWN0aXZlSW5zdGFuY2U6IGFueTtcclxuICBwcml2YXRlIGluaXRpYWxJY29uOiBzdHJpbmc7XHJcbiAgcHJpdmF0ZSBkaXJlY3RpdmVFbGVtZW50UmVmOiBFbGVtZW50UmVmO1xyXG5cclxuICBwcml2YXRlIGxpc3RlbmVyTW91c2VEb3duOiBhbnk7XHJcbiAgcHJpdmF0ZSBsaXN0ZW5lclJlc2l6ZTogYW55O1xyXG5cclxuICBwcml2YXRlIGRpYWxvZ0Fycm93U2l6ZSA9IDEwO1xyXG5cclxuICBAVmlld0NoaWxkKCdkaWFsb2dQb3B1cCcpIGRpYWxvZ0VsZW1lbnQ6IGFueTtcclxuXHJcbiAgaWNvbnM6IEljb25bXSA9IFtdO1xyXG4gIHNlYXJjaCA9ICcnO1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgZWw6IEVsZW1lbnRSZWYsXHJcbiAgICBwcml2YXRlIGNkcjogQ2hhbmdlRGV0ZWN0b3JSZWYsXHJcbiAgICBwcml2YXRlIHNlcnZpY2U6IEljb25QaWNrZXJTZXJ2aWNlKSB7XHJcbiAgfVxyXG5cclxuICBzZXREaWFsb2coaW5zdGFuY2U6IGFueSwgZWxlbWVudFJlZjogRWxlbWVudFJlZiwgaWNvbjogc3RyaW5nLCBpcFBvc2l0aW9uOiBzdHJpbmcsIGlwSGVpZ2h0OiBzdHJpbmcsIGlwTWF4SGVpZ2h0OiBzdHJpbmcsXHJcbiAgICAgICAgICAgIGlwV2lkdGg6IHN0cmluZywgaXBQbGFjZUhvbGRlcjogc3RyaW5nLCBpcEZhbGxiYWNrSWNvbjogc3RyaW5nLCBpcEljb25QYWNrOiBzdHJpbmdbXSwgaXBJY29uU2l6ZTogc3RyaW5nLFxyXG4gICAgICAgICAgICBpcEljb25WZXJ0aWNhbFBhZGRpbmc6IHN0cmluZywgaXBJY29uSG9yaXpvbnRhbFBhZGRpbmc6IHN0cmluZywgaXBCdXR0b25TdHlsZUNsYXNzOiBzdHJpbmcsIGlwRGl2U2VhcmNoU3R5bGVDbGFzczogc3RyaW5nLFxyXG4gICAgICAgICAgICBpcElucHV0U2VhcmNoU3R5bGVDbGFzczogc3RyaW5nLCBpcEtlZXBTZWFyY2hGaWx0ZXI6IHN0cmluZykge1xyXG4gICAgdGhpcy5kaXJlY3RpdmVJbnN0YW5jZSA9IGluc3RhbmNlO1xyXG4gICAgdGhpcy5zZXRJbml0aWFsSWNvbihpY29uKTtcclxuICAgIHRoaXMuZGlyZWN0aXZlRWxlbWVudFJlZiA9IGVsZW1lbnRSZWY7XHJcbiAgICB0aGlzLmlwUG9zaXRpb24gPSBpcFBvc2l0aW9uO1xyXG4gICAgdGhpcy5pcEhlaWdodCA9IHBhcnNlSW50KGlwSGVpZ2h0LCAxMCk7XHJcbiAgICB0aGlzLmlwTWF4SGVpZ2h0ID0gcGFyc2VJbnQoaXBNYXhIZWlnaHQsIDEwKTtcclxuICAgIHRoaXMuaXBXaWR0aCA9IHBhcnNlSW50KGlwV2lkdGgsIDEwKTtcclxuICAgIGlmICghdGhpcy5pcFdpZHRoKSB7XHJcbiAgICAgIHRoaXMuaXBXaWR0aCA9IGVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5vZmZzZXRXaWR0aDtcclxuICAgIH1cclxuICAgIHRoaXMuaXBJY29uU2l6ZSA9IHBhcnNlSW50KGlwSWNvblNpemUsIDEwKTtcclxuICAgIHRoaXMuaXBJY29uVmVydGljYWxQYWRkaW5nID0gcGFyc2VJbnQoaXBJY29uVmVydGljYWxQYWRkaW5nLCAxMCk7XHJcbiAgICB0aGlzLmlwSWNvbkhvcml6b250YWxQYWRkaW5nID0gcGFyc2VJbnQoaXBJY29uSG9yaXpvbnRhbFBhZGRpbmcsIDEwKTtcclxuICAgIHRoaXMuaXBLZWVwU2VhcmNoRmlsdGVyID0gSlNPTi5wYXJzZShpcEtlZXBTZWFyY2hGaWx0ZXIpO1xyXG4gICAgdGhpcy5pcFBsYWNlSG9sZGVyID0gaXBQbGFjZUhvbGRlcjtcclxuICAgIHRoaXMuaXBGYWxsYmFja0ljb24gPSBpcEZhbGxiYWNrSWNvbjtcclxuICAgIHRoaXMuaXBJY29uUGFjayA9IGlwSWNvblBhY2s7XHJcbiAgICB0aGlzLmlwQnV0dG9uU3R5bGVDbGFzcyA9IGlwQnV0dG9uU3R5bGVDbGFzcztcclxuICAgIHRoaXMuaXBJbnB1dFNlYXJjaFN0eWxlQ2xhc3MgPSBpcElucHV0U2VhcmNoU3R5bGVDbGFzcztcclxuICAgIHRoaXMuaXBEaXZTZWFyY2hTdHlsZUNsYXNzID0gaXBEaXZTZWFyY2hTdHlsZUNsYXNzO1xyXG5cclxuICAgIHRoaXMuYnV0dG9uSGVpZ2h0ID0gdGhpcy5pcEljb25TaXplICsgMiAqIHRoaXMuaXBJY29uVmVydGljYWxQYWRkaW5nO1xyXG4gICAgdGhpcy5idXR0b25XaWR0aCA9IHRoaXMuaXBJY29uU2l6ZSArIDIgKiB0aGlzLmlwSWNvbkhvcml6b250YWxQYWRkaW5nO1xyXG4gIH1cclxuXHJcbiAgbmdPbkluaXQoKSB7XHJcbiAgICB0aGlzLmljb25zID0gdGhpcy5zZXJ2aWNlLmdldEljb25zKHRoaXMuaXBJY29uUGFjayk7XHJcbiAgICB0aGlzLmxpc3RlbmVyTW91c2VEb3duID0gKGV2ZW50OiBhbnkpID0+IHRoaXMub25Nb3VzZURvd24oZXZlbnQpO1xyXG4gICAgdGhpcy5saXN0ZW5lclJlc2l6ZSA9ICgpID0+IHRoaXMub25SZXNpemUoKTtcclxuICAgIHRoaXMub3BlbkRpYWxvZyh0aGlzLmluaXRpYWxJY29uKTtcclxuICB9XHJcblxyXG4gIHNldEluaXRpYWxJY29uKGljb246IHN0cmluZykge1xyXG4gICAgdGhpcy5pbml0aWFsSWNvbiA9IGljb247XHJcbiAgICB0aGlzLnNlbGVjdGVkSWNvbiA9IHRoaXMuaWNvbnMuZmluZChlbCA9PiBlbCA/XHJcbiAgICAgIGBmYSBmYS0ke2VsLmlkfWAgPT09IGljb24gfHwgYGdseXBoaWNvbiBnbHlwaGljb24tJHtlbC5pZH1gID09PSBpY29uIHx8IGAke2VsLmlkfWAgPT09IGljb24gOlxyXG4gICAgICBmYWxzZVxyXG4gICAgKTtcclxuICAgIGlmICh0aGlzLmlwS2VlcFNlYXJjaEZpbHRlciAmJiB0aGlzLnNlbGVjdGVkSWNvbiAmJiBpY29uICE9PSB0aGlzLmlwRmFsbGJhY2tJY29uKSB7XHJcbiAgICAgIHRoaXMuc2VhcmNoID0gdGhpcy5zZWxlY3RlZEljb24uaWQ7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLnNlYXJjaCA9ICcnO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgb3BlbkRpYWxvZyhpY29uOiBzdHJpbmcpIHtcclxuICAgIHRoaXMuc2V0SW5pdGlhbEljb24oaWNvbik7XHJcbiAgICB0aGlzLm9wZW5JY29uUGlja2VyKCk7XHJcbiAgfVxyXG5cclxuICBzZXRTZWFyY2godmFsOiBzdHJpbmcpIHtcclxuICAgIHRoaXMuc2VhcmNoID0gdmFsO1xyXG4gIH1cclxuXHJcbiAgc2VsZWN0SWNvbihpY29uOiBJY29uKTogdm9pZCB7XHJcbiAgICBpZiAoaWNvbi50eXBlID09PSBJY29uVHlwZS5GT05UX0FXRVNFT01FKSB7XHJcbiAgICAgIHRoaXMuZGlyZWN0aXZlSW5zdGFuY2UuaWNvblNlbGVjdGVkKGBmYSBmYS0ke2ljb24uaWR9YCk7XHJcbiAgICB9IGVsc2UgaWYgKGljb24udHlwZSA9PT0gSWNvblR5cGUuQk9PVFNUUkFQKSB7XHJcbiAgICAgIHRoaXMuZGlyZWN0aXZlSW5zdGFuY2UuaWNvblNlbGVjdGVkKGBnbHlwaGljb24gZ2x5cGhpY29uLSR7aWNvbi5pZH1gKTtcclxuICAgIH0gZWxzZSBpZiAoaWNvbi50eXBlID09PSBJY29uVHlwZS5GT05UX0FXRVNFT01FNSkge1xyXG4gICAgICB0aGlzLmRpcmVjdGl2ZUluc3RhbmNlLmljb25TZWxlY3RlZChgJHtpY29uLmlkfWApO1xyXG4gICAgfSBlbHNlIGlmIChpY29uLnR5cGUgPT09IEljb25UeXBlLk1BVEVSSUFMKSB7XHJcbiAgICAgIHRoaXMuZGlyZWN0aXZlSW5zdGFuY2UuaWNvblNlbGVjdGVkKGAke2ljb24uaWR9YCk7XHJcbiAgICB9XHJcbiAgICB0aGlzLmNsb3NlSWNvblBpY2tlcigpO1xyXG4gIH1cclxuXHJcbiAgb25Nb3VzZURvd24oZXZlbnQ6IGFueSkge1xyXG4gICAgaWYgKCF0aGlzLmlzRGVzY2VuZGFudCh0aGlzLmVsLm5hdGl2ZUVsZW1lbnQsIGV2ZW50LnRhcmdldCkgJiYgZXZlbnQudGFyZ2V0ICE9PSB0aGlzLmRpcmVjdGl2ZUVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCkge1xyXG4gICAgICB0aGlzLmNsb3NlSWNvblBpY2tlcigpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgb3Blbkljb25QaWNrZXIoKSB7XHJcbiAgICBpZiAoIXRoaXMuc2hvdykge1xyXG4gICAgICB0aGlzLnNob3cgPSB0cnVlO1xyXG4gICAgICB0aGlzLmhpZGRlbiA9IHRydWU7XHJcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgIHRoaXMuc2V0RGlhbG9nUG9zaXRpb24oKTtcclxuICAgICAgICB0aGlzLmhpZGRlbiA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMuY2RyLmRldGVjdENoYW5nZXMoKTtcclxuICAgICAgfSwgMCk7XHJcbiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIHRoaXMubGlzdGVuZXJNb3VzZURvd24pO1xyXG4gICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncmVzaXplJywgdGhpcy5saXN0ZW5lclJlc2l6ZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBjbG9zZUljb25QaWNrZXIoKSB7XHJcbiAgICBpZiAodGhpcy5zaG93KSB7XHJcbiAgICAgIHRoaXMuc2hvdyA9IGZhbHNlO1xyXG4gICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCB0aGlzLmxpc3RlbmVyTW91c2VEb3duKTtcclxuICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIHRoaXMubGlzdGVuZXJSZXNpemUpO1xyXG4gICAgICB0aGlzLmNkci5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBvblJlc2l6ZSgpIHtcclxuICAgIGlmICh0aGlzLnBvc2l0aW9uID09PSAnZml4ZWQnKSB7XHJcbiAgICAgIHRoaXMuc2V0RGlhbG9nUG9zaXRpb24oKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHNldERpYWxvZ1Bvc2l0aW9uKCkge1xyXG4gICAgY29uc3QgZGlhbG9nSGVpZ2h0ID0gdGhpcy5kaWFsb2dFbGVtZW50Lm5hdGl2ZUVsZW1lbnQub2Zmc2V0SGVpZ2h0O1xyXG4gICAgbGV0IG5vZGUgPSB0aGlzLmRpcmVjdGl2ZUVsZW1lbnRSZWYubmF0aXZlRWxlbWVudDtcclxuICAgIGxldCBwb3NpdGlvbiA9ICdzdGF0aWMnO1xyXG4gICAgbGV0IHRyYW5zZm9ybSA9ICcnO1xyXG4gICAgbGV0IHBhcmVudE5vZGU6IGFueSA9IG51bGw7XHJcbiAgICBsZXQgdHJhbnNmb3JtTm9kZTogYW55ID0gbnVsbDtcclxuICAgIGxldCBzdHlsZTogYW55ID0gbnVsbDtcclxuICAgIHdoaWxlIChub2RlICE9PSBudWxsICYmIG5vZGUudGFnTmFtZSAhPT0gJ0hUTUwnKSB7XHJcbiAgICAgIHN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUobm9kZSk7XHJcbiAgICAgIHBvc2l0aW9uID0gc3R5bGUuZ2V0UHJvcGVydHlWYWx1ZSgncG9zaXRpb24nKTtcclxuICAgICAgdHJhbnNmb3JtID0gc3R5bGUuZ2V0UHJvcGVydHlWYWx1ZSgndHJhbnNmb3JtJyk7XHJcbiAgICAgIGlmIChwb3NpdGlvbiAhPT0gJ3N0YXRpYycgJiYgcGFyZW50Tm9kZSA9PT0gbnVsbCkge1xyXG4gICAgICAgIHBhcmVudE5vZGUgPSBub2RlO1xyXG4gICAgICB9XHJcbiAgICAgIGlmICh0cmFuc2Zvcm0gJiYgdHJhbnNmb3JtICE9PSAnbm9uZScgJiYgdHJhbnNmb3JtTm9kZSA9PT0gbnVsbCkge1xyXG4gICAgICAgIHRyYW5zZm9ybU5vZGUgPSBub2RlO1xyXG4gICAgICB9XHJcbiAgICAgIGlmIChwb3NpdGlvbiA9PT0gJ2ZpeGVkJykge1xyXG4gICAgICAgIHBhcmVudE5vZGUgPSB0cmFuc2Zvcm1Ob2RlO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICB9XHJcbiAgICAgIG5vZGUgPSBub2RlLnBhcmVudE5vZGU7XHJcbiAgICB9XHJcbiAgICBjb25zdCBib3hEaXJlY3RpdmUgPSB0aGlzLmNyZWF0ZUJveCh0aGlzLmRpcmVjdGl2ZUVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgKHBvc2l0aW9uICE9PSAnZml4ZWQnKSk7XHJcbiAgICBpZiAocG9zaXRpb24gIT09ICdmaXhlZCcgfHwgcGFyZW50Tm9kZSkge1xyXG4gICAgICBpZiAocGFyZW50Tm9kZSA9PT0gbnVsbCkge1xyXG4gICAgICAgIHBhcmVudE5vZGUgPSBub2RlO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IGJveFBhcmVudCA9IHRoaXMuY3JlYXRlQm94KHBhcmVudE5vZGUsIHRydWUpO1xyXG4gICAgICB0aGlzLnRvcCA9IGJveERpcmVjdGl2ZS50b3AgLSBib3hQYXJlbnQudG9wO1xyXG4gICAgICB0aGlzLmxlZnQgPSBib3hEaXJlY3RpdmUubGVmdCAtIGJveFBhcmVudC5sZWZ0O1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy50b3AgPSBib3hEaXJlY3RpdmUudG9wO1xyXG4gICAgICB0aGlzLmxlZnQgPSBib3hEaXJlY3RpdmUubGVmdDtcclxuICAgIH1cclxuICAgIGlmIChwb3NpdGlvbiA9PT0gJ2ZpeGVkJykge1xyXG4gICAgICB0aGlzLnBvc2l0aW9uID0gJ2ZpeGVkJztcclxuICAgIH1cclxuICAgIGlmICh0aGlzLmlwUG9zaXRpb24gPT09ICdsZWZ0Jykge1xyXG4gICAgICB0aGlzLmxlZnQgLT0gdGhpcy5pcFdpZHRoICsgdGhpcy5kaWFsb2dBcnJvd1NpemUgLSAyO1xyXG4gICAgfSBlbHNlIGlmICh0aGlzLmlwUG9zaXRpb24gPT09ICd0b3AnKSB7XHJcbiAgICAgIHRoaXMudG9wIC09IGRpYWxvZ0hlaWdodCArIHRoaXMuZGlhbG9nQXJyb3dTaXplO1xyXG4gICAgICB0aGlzLmFycm93VG9wID0gZGlhbG9nSGVpZ2h0IC0gMTtcclxuICAgIH0gZWxzZSBpZiAodGhpcy5pcFBvc2l0aW9uID09PSAnYm90dG9tJykge1xyXG4gICAgICB0aGlzLnRvcCArPSBib3hEaXJlY3RpdmUuaGVpZ2h0ICsgdGhpcy5kaWFsb2dBcnJvd1NpemU7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmxlZnQgKz0gYm94RGlyZWN0aXZlLndpZHRoICsgdGhpcy5kaWFsb2dBcnJvd1NpemUgLSAyO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgaXNEZXNjZW5kYW50KHBhcmVudDogYW55LCBjaGlsZDogYW55KTogYm9vbGVhbiB7XHJcbiAgICBsZXQgbm9kZTogYW55ID0gY2hpbGQucGFyZW50Tm9kZTtcclxuICAgIHdoaWxlIChub2RlICE9PSBudWxsKSB7XHJcbiAgICAgIGlmIChub2RlID09PSBwYXJlbnQpIHtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgICBub2RlID0gbm9kZS5wYXJlbnROb2RlO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH1cclxuXHJcbiAgY3JlYXRlQm94KGVsZW1lbnQ6IGFueSwgb2Zmc2V0OiBib29sZWFuKTogYW55IHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHRvcDogZWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS50b3AgKyAob2Zmc2V0ID8gd2luZG93LnBhZ2VZT2Zmc2V0IDogMCksXHJcbiAgICAgIGxlZnQ6IGVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkubGVmdCArIChvZmZzZXQgPyB3aW5kb3cucGFnZVhPZmZzZXQgOiAwKSxcclxuICAgICAgd2lkdGg6IGVsZW1lbnQub2Zmc2V0V2lkdGgsXHJcbiAgICAgIGhlaWdodDogZWxlbWVudC5vZmZzZXRIZWlnaHRcclxuICAgIH07XHJcbiAgfVxyXG59XHJcbiJdfQ==